<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Identity Rolling Capture</title>
    <style>
        body {
            margin: 0;
            background: transparent;
            font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
        }

        .wrap {
            padding: 24px;
        }

        .row {
            display: flex;
            gap: 24px;
            align-items: flex-start;
        }

        .animation-container-js {
            display: inline-block;
            width: 320px;
            min-height: 180px;
        }

        .animation-container-js h2 {
            margin: 0 0 8px 0;
            font-size: 16px;
        }

        .controls {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }

        .btn {
            padding: 6px 10px;
            border: 1px solid #999;
            background: #f5f5f5;
            cursor: pointer;
            border-radius: 6px;
        }

        .btn-primary {
            background: #3d139c;
            color: #fff;
            border-color: #3d139c;
        }

        .js-rolling-container-1,
        .js-rolling-container-2,
        .js-rolling-container-3 {
            position: relative;
            height: 120px;
            width: 300px;
            overflow: hidden;
        }

        #js-rolling-one,
        #js-rolling-two,
        #js-rolling-three {
            position: absolute;
            bottom: 0;
            left: 0;
            f width: 60px;
            height: 60px;
        }
    </style>
  </head>
  <body>
    <div class="wrap">
      <div class="row">
        <div class="animation-container-js">
          <h2>Roll Once (90°)</h2>
          <div class="js-rolling-container-1">
            <div id="js-rolling-one">
              <svg width="60" height="60" viewBox="0 0 82 82">
                <rect x="5" y="5" width="72" height="72" fill="transparent" stroke="#3d139c" stroke-width="10" rx="4" ry="4" />
                <rect x="36" y="36" width="10" height="10" fill="#3d139c" stroke="#3d139c" stroke-width="8" rx="1" ry="1" />
              </svg>
            </div>
          </div>
          <div class="controls">
            <button class="btn btn-primary" onclick="rollOnce()">Start</button>
          </div>
        </div>

        <div class="animation-container-js">
          <h2>Roll Twice (2 × 90°)</h2>
          <div class="js-rolling-container-2">
            <div id="js-rolling-two">
              <svg width="60" height="60" viewBox="0 0 82 82">
                <rect x="5" y="5" width="72" height="72" fill="transparent" stroke="#3d139c" stroke-width="10" rx="4" ry="4" />
                <rect x="36" y="36" width="10" height="10" fill="#3d139c" stroke="#3d139c" stroke-width="8" rx="1" ry="1" />
              </svg>
            </div>
          </div>
          <div class="controls">
            <button class="btn" onclick="resetRollTwice()">Reset</button>
            <button class="btn btn-primary" onclick="rollTwice()">Start</button>
          </div>
        </div>
      </div>

      <div class="row" style="margin-top: 16px;">
        <div class="animation-container-js">
          <h2>Roll Thrice (3 × 90°)</h2>
          <div class="js-rolling-container-3">
            <div id="js-rolling-three">
              <svg width="60" height="60" viewBox="0 0 82 82">
                <rect x="5" y="5" width="72" height="72" fill="transparent" stroke="#3d139c" stroke-width="10" rx="4" ry="4" />
                <rect x="36" y="36" width="10" height="10" fill="#3d139c" stroke="#3d139c" stroke-width="8" rx="1" ry="1" />
              </svg>
            </div>
          </div>
          <div class="controls">
            <button class="btn" onclick="resetRollThrice()">Reset</button>
            <button class="btn btn-primary" onclick="rollThrice()">Start</button>
          </div>
        </div>
      </div>
    </div>

    <script>
        function computeLogoMetricsByEl(wrapperId) {
            const wrapper = document.getElementById(wrapperId);
            const svg = wrapper.querySelector('svg');
            const vb = svg.viewBox.baseVal;
            const scaleX = svg.clientWidth / vb.width;
            const scaleY = svg.clientHeight / vb.height;
            const rects = Array.from(svg.querySelectorAll('rect'));
            const borderRect = rects.reduce((acc, r) => {
                const w = parseFloat(r.getAttribute('width') || '0');
                return (!acc || w > acc.w) ? {
                    el: r,
                    w
                } : acc;
            }, null).el;
            const rx = parseFloat(borderRect.getAttribute('x'));
            const ry = parseFloat(borderRect.getAttribute('y'));
            const rw = parseFloat(borderRect.getAttribute('width'));
            const rh = parseFloat(borderRect.getAttribute('height'));
            const halfStroke = parseFloat(borderRect.getAttribute('stroke-width') || '0') / 2;
            const brPx = {
                x: (rx + rw + halfStroke - vb.x) * scaleX,
                y: (ry + rh + halfStroke - vb.y) * scaleY
            };
            const trPx = {
                x: (rx + rw + halfStroke - vb.x) * scaleX,
                y: (ry - halfStroke - vb.y) * scaleY
            };
            const tlPx = {
                x: (rx - halfStroke - vb.x) * scaleX,
                y: (ry - halfStroke - vb.y) * scaleY
            };
            return {
                brPx,
                trPx,
                tlPx,
                translateStep: svg.clientWidth
            };
        }

        function pivotSwitchPreservePosition(logo, originPx, baseTranslateX, baseTranslateY, rotationDeg) {
            const before = logo.getBoundingClientRect();
            logo.style.transition = 'none';
            logo.style.transformOrigin = `${originPx.x}px ${originPx.y}px`;
            logo.style.transform = `translateX(${baseTranslateX}px) translateY(${baseTranslateY}px) rotate(${rotationDeg}deg)`;
            const after = logo.getBoundingClientRect();
            const dx = before.left - after.left;
            const dy = before.bottom - after.bottom;
            logo.style.transform = `translateX(${baseTranslateX + dx}px) translateY(${baseTranslateY + dy}px) rotate(${rotationDeg}deg)`;
            return {
                dx,
                dy
            };
        }

        // Slowed transitions (1.5s segments)
        const SEG_MS = 1500;

        function rollOnce() {
            const logo = document.getElementById('js-rolling-one');
            const {
                brPx
            } = computeLogoMetricsByEl('js-rolling-one');
            logo.style.transition = 'none';
            logo.style.transform = 'rotate(0deg)';
            logo.style.transformOrigin = `${brPx.x}px ${brPx.y}px`;
            requestAnimationFrame(() => {
                requestAnimationFrame(() => {
                    logo.style.transition = `transform ${SEG_MS}ms ease-in-out`;
                    logo.style.transform = 'rotate(90deg)';
                });
            });
        }

        function resetRollTwice() {
            const logo = document.getElementById('js-rolling-two');
            const {
                brPx
            } = computeLogoMetricsByEl('js-rolling-two');
            logo.style.transition = 'none';
            logo.style.transformOrigin = `${brPx.x}px ${brPx.y}px`;
            logo.style.transform = 'translateX(0px) rotate(0deg)';
        }

        function rollTwice() {
            const logo = document.getElementById('js-rolling-two');
            const {
                brPx,
                trPx,
                translateStep
            } = computeLogoMetricsByEl('js-rolling-two');
            logo.style.transition = 'none';
            logo.style.transformOrigin = `${brPx.x}px ${brPx.y}px`;
            logo.style.transform = 'translateX(0px) rotate(0deg)';
            requestAnimationFrame(() => {
                requestAnimationFrame(() => {
                    logo.style.transition = `transform ${SEG_MS}ms ease-in-out`;
                    logo.style.transform = 'translateX(0px) rotate(90deg)';
                });
            });

            function onFirstEnd(e) {
                if (e.propertyName !== 'transform') return;
                logo.removeEventListener('transitionend', onFirstEnd);
                const cont = pivotSwitchPreservePosition(logo, trPx, translateStep, 0, 90);
                requestAnimationFrame(() => {
                    requestAnimationFrame(() => {
                        logo.style.transition = `transform ${SEG_MS}ms ease-in-out`;
                        logo.style.transform = `translateX(${translateStep + cont.dx}px) translateY(${cont.dy}px) rotate(180deg)`;
                    });
                });
            }
            logo.addEventListener('transitionend', onFirstEnd);
        }

        function resetRollThrice() {
            const logo = document.getElementById('js-rolling-three');
            const {
                brPx
            } = computeLogoMetricsByEl('js-rolling-three');
            logo.style.transition = 'none';
            logo.style.transformOrigin = `${brPx.x}px ${brPx.y}px`;
            logo.style.transform = 'translateX(0px) rotate(0deg)';
        }

        function rollThrice() {
            const logo = document.getElementById('js-rolling-three');
            const {
                brPx,
                trPx,
                tlPx,
                translateStep
            } = computeLogoMetricsByEl('js-rolling-three');
            logo.style.transition = 'none';
            logo.style.transformOrigin = `${brPx.x}px ${brPx.y}px`;
            logo.style.transform = 'translateX(0px) rotate(0deg)';
            requestAnimationFrame(() => {
                requestAnimationFrame(() => {
                    logo.style.transition = `transform ${SEG_MS}ms ease-in-out`;
                    logo.style.transform = 'translateX(0px) rotate(90deg)';
                });
            });

            function onFirstEnd(e) {
                if (e.propertyName !== 'transform') return;
                logo.removeEventListener('transitionend', onFirstEnd);
                const c2 = pivotSwitchPreservePosition(logo, trPx, translateStep, 0, 90);
                requestAnimationFrame(() => {
                    requestAnimationFrame(() => {
                        logo.style.transition = `transform ${SEG_MS}ms ease-in-out`;
                        logo.style.transform = `translateX(${translateStep + c2.dx}px) translateY(${c2.dy}px) rotate(180deg)`;
                    });
                });

                function onSecondEnd(e2) {
                    if (e2.propertyName !== 'transform') return;
                    logo.removeEventListener('transitionend', onSecondEnd);
                    const tx = translateStep * 2;
                    const c3 = pivotSwitchPreservePosition(logo, tlPx, tx, c2.dy, 180);
                    requestAnimationFrame(() => {
                        requestAnimationFrame(() => {
                            logo.style.transition = `transform ${SEG_MS}ms ease-in-out`;
                            logo.style.transform = `translateX(${tx + c3.dx}px) translateY(${c2.dy + c3.dy}px) rotate(270deg)`;
                        });
                    });
                }
                logo.addEventListener('transitionend', onSecondEnd);
            }
            logo.addEventListener('transitionend', onFirstEnd);
        }
    </script>
  </body>
</html>
