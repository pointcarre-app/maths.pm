{# PM Metatags Include - handles all metatag logic for PM pages #}

{# PM page-specific metatags have highest priority #}
{% if pm_metatags %}
  {% for key, value in pm_metatags.items() %}
    {% if key not in ['title'] %}
      {# Title is handled in title block #}
      {% if key.startswith('og:') %}
        <meta property="{{ key }}" content="{{ value }}" />
      {% elif key.startswith('twitter:') %}
        <meta name="{{ key }}" content="{{ value }}" />
      {% elif key.startswith('DC.') %}
        <meta name="{{ key }}" content="{{ value }}" />
      {% elif key.startswith('itemprop') %}
        <meta itemprop="{{ key.replace('itemprop-', '') }}" content="{{ value }}" />
      {% elif key in ['description', 'keywords', 'author', 'robots', 'abstract', 'topic', 'summary', 'category', 'revised', 'pagename', 'subtitle'] %}
        <meta name="{{ key }}" content="{{ value }}" />
      {% else %}
        <meta name="{{ key }}" content="{{ value }}" />
      {% endif %}
    {% endif %}
  {% endfor %}
{% elif product_settings and product_settings.product.metatags %}
  {# Product-specific metatags override domain defaults #}
  {% for key, value in product_settings.product.metatags.items() %}
    {% if key not in ['title'] %}
      {# Title is handled in title block #}
      {% if key.startswith('og:') %}
        <meta property="{{ key }}" content="{{ value }}" />
      {% elif key.startswith('twitter:') %}
        <meta name="{{ key }}" content="{{ value }}" />
      {% elif key.startswith('DC.') %}
        <meta name="{{ key }}" content="{{ value }}" />
      {% elif key.startswith('itemprop') %}
        <meta itemprop="{{ key.replace('itemprop-', '') }}" content="{{ value }}" />
      {% elif key == 'description' %}
        {# Override the base template's description #}
        <meta name="description" content="{{ value }}" />
      {% elif key == 'keywords' %}
        <meta name="keywords" content="{{ value }}" />
      {% else %}
        <meta name="{{ key }}" content="{{ value }}" />
      {% endif %}
    {% endif %}
  {% endfor %}
{% elif pm %}
  {# Fallback to PM-based metadata if no metatags #}
  <meta name="description"
        content="{{ pm.title }} - {{ pm.chapter if pm.chapter else 'Cours de mathÃ©matiques' }}" />
{% endif %}

{# Canonical URL for this PM page #}
{% if origin %}
  <link rel="canonical" href="{{ request.url_for('get_pm', origin=origin) }}" />
  <meta name="url" content="{{ request.url_for('get_pm', origin=origin) }}" />
  <meta name="identifier-URL" content="{{ request.url_for('get_pm', origin=origin) }}" />
{% endif %}
