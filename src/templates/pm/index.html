{% extends "base/main-alt.html" %}
{# 
  Standard PM Page Template
  
  This template can be simplified by using pm-include templates:
  - See pm/index-refactored.html for the simplified version
  - See pm-include/README.md for usage documentation
#}

{% block title %}
  {# Priority: PM page metatags > Product metatags > PM title > Domain defaults #}
  {% if pm_metatags and pm_metatags.title %}
    {{ pm_metatags.title }}
  {% elif product_settings and product_settings.product.metatags and product_settings.product.metatags.title %}
    {{ product_settings.product.metatags.title }}
  {% elif pm and pm.title %}
    {{ pm.title }} - {{ DOMAIN_CONFIG['index_view_specific_metatags']['title'] }}
  {% else %}
    {{ DOMAIN_CONFIG['index_view_specific_metatags']['title'] }}
  {% endif %}
{% endblock title %}

{% block extra_head %}

  {# Load Product-specific CSS dependencies from backend_settings #}
  {% if product_settings and product_settings.product and product_settings.product.backend_settings %}
    {% if product_settings.product.backend_settings.css_dependencies %}
      <!-- Product CSS dependencies ({{ product_settings.product.name }}) -->
      {% for css_dep in product_settings.product.backend_settings.css_dependencies %}
        <link rel="stylesheet" href="{{ css_dep }}" />
      {% endfor %}
    {% endif %}
  {% endif %}

  {# Load PM-specific CSS dependencies (from PM metadata) if they exist #}
  {% if pm and pm.css_dependencies %}
    <!-- PM-specific CSS dependencies (from markdown metadata) -->
    {% for css_dep in pm.css_dependencies %}<link rel="stylesheet" href="{{ css_dep }}" />{% endfor %}
  {% endif %}

  {# Load Product-specific JS dependencies from backend_settings #}
  {% if product_settings and product_settings.product and product_settings.product.backend_settings %}
    {% if product_settings.product.backend_settings.js_dependencies %}
      <!-- Product JS dependencies ({{ product_settings.product.name }}) -->
      {% for js_dep in product_settings.product.backend_settings.js_dependencies %}
        <script src="{{ js_dep }}"></script>
      {% endfor %}
    {% endif %}
  {% endif %}

  {# Load PM-specific JS dependencies (from PM metadata) if they exist #}
  {% if pm and pm.js_dependencies %}
    <!-- PM-specific JS dependencies (from markdown metadata) -->
    {% for js_dep in pm.js_dependencies %}<script src="{{ js_dep }}"></script>{% endfor %}
  {% endif %}

  {# Include all PM head resources - simplified version available #}
  {# You can also use: {% include "pm-include/head-resources.html" %} #}
  {# <link rel="stylesheet" href="{{ request.url_for('static', path='core/css/pm.css') }}" /> #}
  {# <link rel="stylesheet" href="{{ request.url_for('static', path='core/css/toc.css') }}" /> #}
  <!-- MathLive for LaTeX (if needed later) -->
  <script src="https://cdn.jsdelivr.net/npm/mathlive@0.105.2/mathlive.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/mathlive@0.105.2/mathlive-static.min.css" rel="stylesheet" />
  <!-- CodeMirror (for codex_ rendering) -->
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css" />
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js"></script>
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/python/python.min.js"></script>

  {# Todo: Ensure stability cross domains  / producs #}

  {# Include PM metatags logic #}
  {% include "pm/includes/metatags.html" %}

{% endblock extra_head %}

{% block content %}

  {# This entire block can be replaced with: {% include "pm-include/render-full.html" %} #}

  {# Should be dealt at the ressources config level ie yaml + settings #}
  {% if product_settings and product_settings.name != "sujets0" %}
    {% include "pm/includes/toc-sidebar.html" %}
  {% endif %}

  <div class="pm-container lg:text-lg w-full mx-auto">
    <div id="pm-background-container"
         class="bg-base-100 shadow-xl mt-12 px-3 sm:px-10 md:px-12 lg:px-14 py-4 sm:py-8 md:py-10 lg:py-12 mx-auto transition-all duration-300">

      <div class="breadcrumbs text-sm">
        <ul>
          <li>
            <a class="btn btn-sm btn-outline" href="{{ product_settings.local_path }}">{{ product_settings.title|safe }}</a>
          </li>
          <li>{{ pm.title | safe }}</li>
        </ul>
      </div>

      <!-- Main Content -->
      <div id="pm-wrapper-max-width" class="max-w-[640px] mx-auto md:pb-12 bg-base-100">

        {# Include product warning message #}
        {% include "pm/includes/product-warning.html" %}

        <!-- Fragments (rendered via partials) -->
        {% include "pm/includes/fragments-renderer.html" %}
      </div>

      {# Include debug section when debug mode is enabled #}
      {% include "pm/includes/debug-section.html" %}

      {# Include PM runtime initialization #}
      {% include "pm/includes/runtime-init.html" %}
    </div>
  </div>

  <!-- Scroll to Top Button -->
  <button class="btn btn-circle btn-lg btn-primary fixed bottom-4 sm:bottom-8 right-4 sm:right-8 z-50 shadow-lg hover:scale-105 transition-all duration-300 hidden sm:inline-flex"
          id="scroll-to-top">
    <svg xmlns="http://www.w3.org/2000/svg"
         class="w-6 h-6"
         viewBox="0 0 24 24"
         fill="none"
         stroke="currentColor"
         stroke-width="2"
         stroke-linecap="round"
         stroke-linejoin="round">
      <path d="M5 3h14" />
      <path d="m18 13-6-6-6 6" />
      <path d="M12 7v14" />
    </svg>
  </button>

  <script>
      document.addEventListener("DOMContentLoaded", function() {
          const scrollToTopBtn = document.getElementById("scroll-to-top");

          if (scrollToTopBtn) {
              scrollToTopBtn.addEventListener("click", function() {
                  window.scrollTo({
                      top: 0,
                      behavior: 'smooth'
                  });
              });
          }
      });
  </script>

  <script>
      document.addEventListener('click', function(e) {
          if (e.target.matches('.copy-btn') || e.target.closest('.copy-btn')) {
              const button = e.target.closest('.copy-btn');
              const codeElement = button.closest('.fragment').querySelector('code');
              navigator.clipboard.writeText(codeElement.textContent);

              // Change button color briefly for feedback
              const originalBg = button.style.background;
              button.style.background = '#10b981';
              setTimeout(() => button.style.background = originalBg, 1000);
          }
      });
  </script>

  <script>
      document.addEventListener("DOMContentLoaded", function() {
          // Width selector functionality
          const widthButtons = document.querySelectorAll('[data-width-selector]');
          const pmWrapper = document.getElementById('pm-wrapper-max-width');
          const backgroundContainer = document.getElementById('pm-background-container');

          function setWidth(width) {
              if (pmWrapper && backgroundContainer) {
                  // Update content wrapper max-width
                  pmWrapper.style.maxWidth = width;

                  // Update background container with wider spacing (128px extra for breathing room)
                  const widthValue = parseInt(width);
                  const containerWidth = widthValue + 128;
                  backgroundContainer.style.maxWidth = containerWidth + 'px';
              }
          }

          widthButtons.forEach(button => {
              button.addEventListener('click', function() {
                  const selectedWidth = this.getAttribute('data-width-selector');
                  setWidth(selectedWidth);

                  // Update button states (visual feedback)
                  widthButtons.forEach(btn => btn.classList.remove('btn-active'));
                  this.classList.add('btn-active');
              });
          });

          // Set initial state for 640px (default)
          setWidth('640px');
          const defaultButton = document.querySelector('[data-width-selector="640px"]');
          if (defaultButton) {
              defaultButton.classList.add('btn-active');
          }
      });
  </script>

  <!-- djlint:on -->
{% endblock content %}
