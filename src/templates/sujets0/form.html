{% extends "base/main-alt.html" %}
{% block title %}

  {% if product_metatags and
    product_metatags.title %}
    {{ product_metatags.title }}
  {% else %}
    Sujets 0 -
    Exercices mathématiques pour l'épreuve anticipée de 1ère
  {% endif %}

{% endblock title %}

{% block extra_head %}
  {# Product-specific metatags override defaults #}
  {% if product_metatags %}
    {# SEO metatags #}
    {% if product_metatags.description %}
      <meta name="description" content="{{ product_metatags.description }}" />
    {% endif %}

    {% if product_metatags.keywords %}
      <meta name="keywords" content="{{ product_metatags.keywords }}" />
    {% endif %}

    {% if product_metatags.robots %}
      <meta name="robots" content="{{ product_metatags.robots }}" />
    {% endif %}
    {# Open Graph metatags #}
    {% if product_metatags['og:title'] %}
      <meta property="og:title" content="{{ product_metatags['og:title'] }}" />
    {% endif %}

    {% if product_metatags['og:description'] %}
      <meta property="og:description" content="{{ product_metatags['og:description'] }}" />
    {% endif %}

    {% if product_metatags['og:image'] %}
      <meta property="og:image" content="{{ product_metatags['og:image'] }}" />
    {% endif %}

    {% if product_metatags['og:url'] %}
      <meta property="og:url" content="{{ product_metatags['og:url'] }}" />
    {% endif %}
    {# Twitter Card metatags #}
    {% if product_metatags['twitter:card'] %}
      <meta name="twitter:card" content="{{ product_metatags['twitter:card'] }}" />
    {% endif %}

    {% if product_metatags['twitter:title'] %}
      <meta name="twitter:title" content="{{ product_metatags['twitter:title'] }}" />
    {% endif %}

    {% if product_metatags['twitter:description'] %}
      <meta name="twitter:description" content="{{ product_metatags['twitter:description'] }}" />
    {% endif %}

    {% if product_metatags['twitter:image'] %}
      <meta name="twitter:image" content="{{ product_metatags['twitter:image'] }}" />
    {% endif %}
    {# Dublin Core metatags #}
    {% for key, value in product_metatags.items() %}
      {% if key.startswith('DC.') %}<meta name="{{ key }}" content="{{ value }}" />{% endif %}
    {% endfor %}
    {# Any other custom metatags #}
    {% if product_metatags.revised %}
      <meta name="revised" content="{{ product_metatags.revised }}" />
    {% endif %}

    {% if product_metatags.topic %}
      <meta name="topic" content="{{ product_metatags.topic }}" />
    {% endif %}

    {% if product_metatags.summary %}
      <meta name="summary" content="{{ product_metatags.summary }}" />
    {% endif %}

    {% if product_metatags.category %}
      <meta name="category" content="{{ product_metatags.category }}" />
    {% endif %}

  {% endif %}
  {# Backend settings loaded from data-brick in the content block #}

  <script type="module">
      import {
          initializeTabs
      } from "/static/js/sujets0/index-ui.js";

      document.addEventListener("DOMContentLoaded", function() {
          initializeTabs();
      });
  </script>
{% endblock extra_head %}

{% block modal_info_content %}
  {% include "sujets0/modal-info-content.html" %}
{% endblock modal_info_content %}

{% block content %}
  <div class="padding-alt-security mx-auto mb-14 mt-8 max-w-4xl">
    {% include "sujets0/header.html" %}

    {% include "sujets0/tabs.html" %}

    <div class="tab-alt-content" id="generate-content">


      <div class="font-heading text-lg sm:text-2xl md:text-3xl mb-4">Première partie : Automatismes</div>


      <div class="text-sm sm:text-base mb-6 text-base-content/70 md:px-6 md:py-10 md:bg-base-100 md:border-base-300 md:border-1"
           style="border-radius: var(--radius-box)">

        <div class="max-w-[640px] mx-auto">
          <!-- Configuration Section -->

          <form id="arpege-form">
            <!-- 2x2 Grid Layout -->
            <div class="grid grid-cols-1 sm:grid-cols-1 gap-4">
              <!-- Top Left: Number of copies -->
              <fieldset class="fieldset">
                <legend class="fieldset-legend">
                  <span class="font-light font-heading text-xl text-base-content/80">Nombre de copies</span>
                  <div class="tooltip  tooltip-top"
                       data-tip="Toutes les copies utiliseront les mêmes questions avec des valeurs différentes">
                    <span class="badge badge-outline badge-sm ml-2 cursor-help text-base-content/60">?</span>
                  </div>
                </legend>
                <div class="join w-full mt-2">
                  <input type="number"
                         id="nb-eleves"
                         name="nb-eleves"
                         min="1"
                         max="50"
                         value="2"
                         required
                         class="input sm:input-lg input-bordered join-item flex-1 h-10" />
                  <button type="button"
                          class="btn sm:btn-lg btn-square join-item"
                          onclick="document.getElementById('nb-eleves').stepDown()">−</button>
                  <button type="button"
                          class="btn sm:btn-lg btn-square join-item"
                          onclick="document.getElementById('nb-eleves').stepUp()">+</button>
                </div>
                <p class="label-text-alt mt-1">Entre 1 et 50 copies</p>
              </fieldset>

              <hr class="my-4 border-base-300" />

              <!-- Top Right: Specialty selection -->
              <fieldset class="fieldset" id="programme-fieldset">
                <legend class="fieldset-legend">
                  <span class="font-light font-heading text-xl text-base-content/80">Sujet 0 pour la génératon</span>
                  <div class="tooltip tooltip-top"
                       data-tip="Choisissez un sujet 0 correspondant à votre classe : Spé 1-2 pour spécialité maths, Ens. Spécifique 1-3 pour enseignement spécifique et Techno 1-2 pour filières technologiques">
                    <span class="badge badge-outline badge-sm badge-rounded ml-2 cursor-help text-base-content/60">?</span>
                  </div>
                </legend>
                <div class="space-y-3 mt-2" id="programme-radio-group">
                  <!-- Spécialité Group -->
                  <div>
                    <div class="text-base font-light text-base-content/60 mb-2">
                      <span class="badge badge-info badge-soft">Spécialité</span>
                    </div>
                    <div class="join w-full">
                      <input type="radio"
                             name="sujets0"
                             value="spe_sujet1"
                             class="join-item btn btn-info btn-outline  flex-1"
                             aria-label="Sujet 0 n°1"
                             style="font-weight: 300" />
                      <input type="radio"
                             name="sujets0"
                             value="spe_sujet2"
                             class="join-item btn btn-info btn-outline  flex-1"
                             aria-label="Sujet 0 n°2"
                             style="font-weight: 300" />
                    </div>
                  </div>

                  <!-- Enseignement Spécifique Group -->
                  <div>
                    <div class="text-base font-light text-base-content/60 mt-4 mb-2">
                      <span class="badge badge-info badge-soft">Enseignement Spécifique</span>
                    </div>
                    <div class="join w-full">
                      <input type="radio"
                             name="sujets0"
                             value="gen_sujet1"
                             class="join-item btn btn-info btn-outline  flex-1"
                             aria-label="Sujet 0 n°1"
                             style="font-weight:300" />
                      <input type="radio"
                             name="sujets0"
                             value="gen_sujet2"
                             class="join-item btn btn-info btn-outline  flex-1"
                             aria-label="Sujet 0 n°2"
                             style="font-weight:300" />
                      <input type="radio"
                             name="sujets0"
                             value="gen_sujet3"
                             class="join-item btn btn-info btn-outline  flex-1"
                             aria-label="Sujet 0 n°3"
                             style="font-weight:300" />
                    </div>
                  </div>

                  <!-- Technologique Group -->
                  <div>
                    <div class="text-base font-light text-base-content/60 mt-4 mb-2">
                      <span class="badge badge-info badge-soft">Technologique</span>
                    </div>

                    <div class="join w-full">
                      <input type="radio"
                             name="sujets0"
                             value="techno_sujet1"
                             class="join-item btn btn-info btn-outline  flex-1"
                             aria-label="Sujet 0 n°1"
                             style="font-weight:300"
                             disabled />
                      <input type="radio"
                             name="sujets0"
                             value="techno_sujet2"
                             class="join-item btn btn-info btn-outline  flex-1"
                             aria-label="Sujet 0 n°2"
                             style="font-weight:300"
                             disabled />
                    </div>
                  </div>
                </div>
                <p class="label-text-alt mt-1" id="programme-help-text">
                  Choisir un sujet 0 officiel <strong>(obligatoire)</strong>
                </p>
                <p class="label-text-alt mt-1 text-error hidden" id="programme-error-text">
                  ⚠️ Veuillez sélectionner un sujet 0 pour une filière spécifique avant de générer les copies
                </p>
              </fieldset>

              <hr class="my-4 border-base-300" />

              <!-- Bottom Left: Questions per copy -->
              <fieldset class="fieldset" hidden>
                <legend class="fieldset-legend">
                  <span class="font-light font-heading text-base sm:text-lg text-base-content/80">Questions par copie</span>
                  <div class="tooltip tooltip-top" data-tip="Une partie A d'un sujet 0 officiel compte 12 questions">
                    <span class="badge badge-outline badge-sm ml-2 cursor-help text-base-content/60">?</span>
                  </div>
                </legend>
                <div class="join w-full">
                  <input type="number"
                         id="nb-questions"
                         name="nb-questions"
                         min="1"
                         max="12"
                         value="12"
                         required
                         class="input input-bordered join-item flex-1 h-10" />
                  <button type="button"
                          class="btn btn-square join-item h-10 w-10"
                          onclick="document.getElementById('nb-questions').stepDown()">−</button>
                  <button type="button"
                          class="btn btn-square join-item h-10 w-10"
                          onclick="document.getElementById('nb-questions').stepUp()">+</button>
                </div>
                <p class="label-text-alt mt-1">Entre 1 et 12 questions</p>
              </fieldset>

              <!-- Bottom Right: Seed number -->
              <fieldset class="fieldset">
                <legend class="fieldset-legend">
                  <span class="font-light font-heading text-xl text-base-content/80">Seed</span>
                  <div class="tooltip tooltip-top"
                       data-tip="Numéro de graine pour la reproductibilité de la génération aléatoire des copies">
                    <span class="badge badge-outline badge-sm ml-2 cursor-help text-base-content/60">?</span>
                  </div>
                </legend>
                <div class="join w-full mt-2">
                  <input type="number"
                         id="seed"
                         name="seed"
                         min="1"
                         max="100"
                         required
                         class="input sm:input-lg input-bordered join-item flex-1 h-10" />
                  <button type="button"
                          class="btn btn-square sm:btn-lg join-item h-10 w-10"
                          onclick="document.getElementById('seed').stepDown()">−</button>
                  <button type="button"
                          class="btn btn-square sm:btn-lg join-item h-10 w-10"
                          onclick="document.getElementById('seed').stepUp()">+</button>
                </div>
                <p class="label-text-alt mt-1">Entre 1 et 100</p>
              </fieldset>
            </div>
            <button id="big-generate-btn"
                    type="button"
                    class="btn btn-primary w-full font-bold bg-primary-focus hover:bg-primary-focus border-0 mt-8">
              <svg class="w-8 h-8 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z" />
              </svg>
              Générer les copies
            </button>
          </form>

          <div class="p-4 sm:p-6 sm:bg-base-200 mt-6">
            <ul class="list-disc list-inside text-sm text-base-content/60">
              <li>
                Les copies proposent dans le même ordre les 12 mêmes questions d'un des sujets 0 publiés par le ministère.
              </li>
              <li>Des valeurs numériques différentes sont utilisées dans les copies.</li>
              <li>Les corrigés pour l'enseignant sont inclus séparément.</li>
            </ul>
          </div>
        </div>
      </div>

      <!-- Big Generate Button -->

      <!-- JavaScript for form-based generation -->
      <script>
          // Function to add error styling to programme radio group
          function addProgrammeError() {
              const radioGroup = document.getElementById('programme-radio-group');
              const errorText = document.getElementById('programme-error-text');
              const helpText = document.getElementById('programme-help-text');

              if (radioGroup) {
                  radioGroup.classList.add('border-2', 'border-error', 'rounded-box');
                  radioGroup.style.padding = '2px';
              }
              if (errorText) {
                  errorText.classList.remove('hidden');
              }
              if (helpText) {
                  helpText.classList.add('hidden');
              }
          }

          // Function to remove error styling from programme radio group
          function removeProgrammeError() {
              const radioGroup = document.getElementById('programme-radio-group');
              const errorText = document.getElementById('programme-error-text');
              const helpText = document.getElementById('programme-help-text');

              if (radioGroup) {
                  radioGroup.classList.remove('border-2', 'border-error', 'rounded-box');
                  radioGroup.style.padding = '';
              }
              if (errorText) {
                  errorText.classList.add('hidden');
              }
              if (helpText) {
                  helpText.classList.remove('hidden');
              }
          }

          // Extract form configuration
          function extractFormConfig() {
              // Get form values
              const nbStudents = document.getElementById("nb-eleves")?.value || 2;
              const nbQuestions =
                  document.getElementById("nb-questions")?.value || 12;
              const seed = document.getElementById("seed")?.value || 9;

              // Get selected curriculum from radio buttons
              const curriculumRadio = document.querySelector(
                  'input[name="sujets0"]:checked'
              );
              let curriculum = null;
              console.log("🔍 Curriculum radio:", curriculumRadio);
              //let curriculum = 'Spé'; // default

              if (curriculumRadio !== null) {
                  switch (curriculumRadio.value) {
                      case "spe_sujet1":
                          curriculum = "Spé 1";
                          break;
                      case "spe_sujet2":
                          curriculum = "Spé 2";
                          break;
                      case "gen_sujet1":
                          curriculum = "Ens. Spé 1";
                          break;
                      case "gen_sujet2":
                          curriculum = "Ens. Spé 2";
                          break;
                      case "gen_sujet3":
                          curriculum = "Ens. Spé 3";
                          break;
                      case "techno_sujet1":
                          curriculum = "Techno 1";
                          break;
                      case "techno_sujet2":
                          curriculum = "Techno 2";
                          break;
                          // default:
                          // throw new Error('Invalid curriculum');
                  }
              } else {
                  // Add error styling and scroll to the error
                  addProgrammeError();
                  const programmeFieldset = document.getElementById('programme-fieldset');
                  if (programmeFieldset) {
                      programmeFieldset.scrollIntoView({
                          behavior: 'smooth',
                          block: 'center'
                      });
                  }
                  throw new Error("Curriculum not selected");
              }

              const curriculumSlug = curriculumRadio.value;

              return {
                  nbStudents,
                  nbQuestions,
                  seed,
                  curriculum,
                  curriculumSlug,
              };
          }

          // Generate exercises based on form data
          function generateFromForm() {
              let config;
              try {
                  config = extractFormConfig();
              } catch (error) {
                  console.error("Configuration error:", error);
                  return; // Stop execution if configuration is invalid
              }

              // Validate the configuration
              const nbStudents = parseInt(config.nbStudents);
              const nbQuestions = parseInt(config.nbQuestions);
              const seed = parseInt(config.seed);
              const curriculumSlug = config.curriculumSlug;

              if (isNaN(nbStudents) || nbStudents < 1 || nbStudents > 50) {
                  alert("⚠️ Le nombre de copies doit être entre 1 et 50");
                  return;
              }

              if (isNaN(nbQuestions) || nbQuestions < 1 || nbQuestions > 12) {
                  alert("⚠️ Le nombre de questions doit être entre 1 et 12");
                  return;
              }

              if (isNaN(seed) || seed < 1 || seed > 100) {
                  alert("⚠️ La graine aléatoire doit être entre 1 et 100");
                  return;
              }

              console.log("🎯 Generating with config:", config);

              // Build the target URL - adapt based on hosting environment
              const baseUrl = `${window.location.protocol}//${window.location.host}`;

              // Check deployment environment
              const hostname = window.location.hostname;
              const isLegacyGitHubPages = hostname.includes(".github.io");
              const isProduction = hostname === "maths.pm" || isLegacyGitHubPages;

              // Construct the appropriate path based on hosting environment
              let targetPath;
              if (isLegacyGitHubPages) {
                  // Legacy GitHub Pages: include /maths.pm prefix and use .html extension
                  targetPath = `/maths.pm/pm/sujets0/a_generate.html`;
              } else if (isProduction) {
                  // Production (maths.pm): direct path with .html extension
                  targetPath = `/pm/sujets0/a_generate.html`;
              } else {
                  // Local development: direct path with .md extension
                  targetPath = `/pm/sujets0/a_generate.md`;
              }

              const targetUrl = `${baseUrl}${targetPath}?format=html&nbStudents=${
          config.nbStudents
        }&nbQuestions=${config.nbQuestions}&seed=${
          config.seed
        }&curriculum-slug=${encodeURIComponent(
          config.curriculumSlug
        )}&curriculum=${encodeURIComponent(config.curriculum)}`;

              console.log("🚀 Navigating to:", targetUrl);

              // Navigate to the URL
              //window.location.href = targetUrl;
              // Open in new tab + safe
              window.open(targetUrl, '_blank', 'noopener,noreferrer');

          }

          // Set random seed value
          function setRandomSeed() {
              const seedInput = document.getElementById("seed");
              if (seedInput) {
                  // Generate random number between 1 and 100 (inclusive)
                  const randomSeed = Math.floor(Math.random() * 100) + 1;
                  seedInput.value = randomSeed;
                  console.log("🎲 Random seed set to:", randomSeed);
              } else {
                  console.warn("Seed input not found");
              }
          }

          // Initialize the generate button when the page loads
          function initializeGenerateButton() {
              const generateBtn = document.getElementById("big-generate-btn");
              if (generateBtn) {
                  generateBtn.addEventListener("click", generateFromForm);
                  console.log("✅ Generate button initialized");
              } else {
                  console.warn("Generate button not found");
              }

              // Add event listeners to radio buttons to remove error styling when selected
              const radioButtons = document.querySelectorAll('input[name="sujets0"]');
              radioButtons.forEach(radio => {
                  radio.addEventListener("change", removeProgrammeError);
              });

              // Set random seed on page load
              setRandomSeed();
          }

          // Wait for DOM to be ready
          if (document.readyState === "loading") {
              document.addEventListener("DOMContentLoaded", initializeGenerateButton);
          } else {
              initializeGenerateButton();
          }
      </script>


      <div class="font-heading text-lg sm:text-2xl md:text-3xl mb-4 mt-8">
        Deuxième partie : Exercices
      </div>


      <div class="text-sm sm:text-base text-base-content/70 md:px-6 md:py-10 md:bg-base-100 md:border-base-300 md:border-1"
           style="border-radius: var(--radius-box)">

        <div class="w-full max-w-[720px] mx-auto">


          <div class="text-sm sm:text-base mb-6 text-base-content/70 md:bg-base-100 md:border-base-300"
               style="border-radius: var(--radius-box)">🚧 🏗️ En cours de développement.</div>

        </div>
      </div>


    </div>

    <div class="tab-alt-content tab-alt-hidden" id="documentation-content">
      {% include "sujets0/documentation.html" %}
    </div>
  </div>
{% endblock content %}


{#
    <div role="alert" class="alert alert-warning alert-soft border-1 mb-6" style=" border-radius: var(--radius-card) !important; border-color: var(--color-warning) !important; background-color: var(--color-base-100) !important; ">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 shrink-0 stroke-current" fill="none" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
      </svg>
      <span><span class="font-handwritten text-lg">Maths.pm</span> ne collecte
        aucune donnée. Toute l'exécution a lieu dans le navigateur. Si votre
        ordinateur connaît des ralentisssements trop importants lors de la
        génération de questions, vous pouvez utiliser ces
        <a href="/sujets0/pre-genetated" class="link link-primary">fichiers PDFs</a>
        qui contiennent des exercices pré-générés.</span>
    </div>
    <div role="alert" class="alert alert-info alert-soft border-1 mb-6" style=" border-radius: var(--radius-card) !important; border-color: var(--color-info) !important; background-color: var(--color-base-100) !important; ">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="h-6 w-6 shrink-0 stroke-current">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
      </svg>
      <span>Lorsque vous arrivez sur la page et pour vous faire gagner du temps, le
        générateur s'exécute automatiquement. Quelques questions sont générées
        pour deux copies (i.e. deux élèves).</span>
    </div>
#} {# {% include "sujets0/form.html" %} #}

<!-- Sujets0 Generate Content - REFACTORED with unified UI -->
