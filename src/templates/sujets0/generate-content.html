<style>
    @media (max-width: 639px) {
        #nb-eleves {
            width: calc(100% - 40px - 40px);
        }

        #nb-questions {
            width: calc(100% - 40px - 40px);
        }
    }

    /* Error states for form fields */
    .input-error {
        border-color: hsl(var(--er)) !important;
        border-width: 2px !important;
    }

    .ring-2.ring-error {
        box-shadow: 0 0 0 2px hsl(var(--er)) !important;
        border-radius: 0.5rem;
    }

    /* Smooth transition for error states */
    .input,
    .join {
        transition: border-color 0.2s, box-shadow 0.2s;
    }

    /* Graph Rendering Styles  for v4pyjs */


    /* LaTeX Rendering Styles */


    .svg-latex {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 100%;
        height: 100%;
        padding: 0;
        box-sizing: border-box;
        border-radius: 0.25rem;
        font-size: 0.875rem;
    }

    foreignObject .katex {
        margin: 0 !important;
        padding: 0 !important;
        line-height: 1 !important;
        font-size: inherit !important;
        color: inherit !important;
        text-align: center;
    }

    foreignObject div {
        height: 100%;
        width: 100%;
        color: inherit !important;
    }

    /* Essential text size for graph labels */
    .text-2xs {
        font-size: 0.625rem !important;
        line-height: 1 !important;
    }
</style>


<div class="font-heading text-lg sm:text-xl md:text-2xl mt-12 mb-4 flex items-center gap-2">
  Configurer la génération d'exercices
</div>

<div class="flex card justify-center px-2 mt-0 sm:px-4 md:px-8 bg-base-200 shadow-sm">
  <form class="w-full my-4" id="arpege-form">
    <!-- Two main columns: numbers on left, radio buttons on right -->
    <div class="flex flex-col sm:flex-row gap-4 sm:gap-8">
      <!-- Left column: Number inputs -->
      <div class="flex flex-col gap-4 sm:gap-8 flex-1">
        <fieldset class="fieldset">
          <legend class="fieldset-legend w-full flex justify-between items-center">
            <div class="font-light font-heading text-base md:text-lg">Copies à générer</div>
            <div class="relative">
              <div class="badge badge-outline badge-sm cursor-help peer">?</div>
              <div class="absolute bottom-full right-0 mb-2 px-3 py-2 bg-base-300 text-base-content text-sm rounded shadow-lg opacity-0 pointer-events-none peer-hover:opacity-100 peer-hover:pointer-events-auto transition-opacity duration-200 whitespace-nowrap z-50"
                   style="font-weight: 300 !important">
                Toutes les copies utiliseront
                <br />
                les mêmes questions issues des sujets 0,
                <br />
                mais avec des valeurs aléatoires.
              </div>
            </div>
            <div class="relative hidden">
              <div class="badge badge-outline badge-sm cursor-help peer">?</div>
              <div class="absolute bottom-full right-0 mb-2 px-3 py-2 bg-base-300 text-base-content text-sm rounded shadow-lg opacity-0 pointer-events-none peer-hover:opacity-100 peer-hover:pointer-events-auto transition-opacity duration-200 whitespace-nowrap z-50"
                   style="font-weight: 300 !important">tooltiptext</div>
            </div>
          </legend>
          <div class="join w-full">
            <input type="number"
                   id="nb-eleves"
                   name="nb-eleves"
                   min="1"
                   max="50"
                   value="1"
                   required
                   class="input join-item w-full"
                   aria-describedby="nb-eleves-help" />
            <button type="button"
                    class="btn join-item"
                    onclick="document.getElementById('nb-eleves').stepDown()"
                    style="width:40px;
                           height:40px">-</button>
            <button type="button"
                    class="btn join-item"
                    onclick="document.getElementById('nb-eleves').stepUp()"
                    style="width:40px;
                           height:40px">+</button>
          </div>
          <p class="label">Obligatoire, entre 1 et 50.</p>
        </fieldset>

        <fieldset class="fieldset">
          <legend class="fieldset-legend w-full flex justify-between items-center">
            <div class="font-light font-heading text-base md:text-lg">Questions par copie</div>
            <div class="relative">
              <div class="badge badge-outline badge-sm cursor-help peer">?</div>
              <div class="absolute bottom-full right-0 mb-2 px-3 py-2 bg-base-300 text-base-content text-sm rounded shadow-lg opacity-0 pointer-events-none peer-hover:opacity-100 peer-hover:pointer-events-auto transition-opacity duration-200 whitespace-nowrap z-50"
                   style="font-weight: 300 !important">
                Nombre de questions
                <br />
                par copie (entre 1 et 12).
                <br />
                Une partie A d'un sujet 0 officiel
                <br />
                compte 12 questions.
              </div>
            </div>
          </legend>
          <div class="join w-full">
            <input type="number"
                   id="nb-questions"
                   name="nb-questions"
                   min="1"
                   max="12"
                   value="12"
                   required
                   class="input join-item w-full"
                   aria-describedby="nb-questions-help" />
            <button type="button" class="btn join-item" onclick="document.getElementById('nb-questions').stepDown()">
              -
            </button>
            <button type="button" class="btn join-item" onclick="document.getElementById('nb-questions').stepUp()">
              +
            </button>
          </div>
          <p class="label">Obligatoire, entre 1 et 12.</p>
        </fieldset>
      </div>

      <!-- Right column: Radio buttons -->
      <div class="flex flex-col gap-4 sm:gap-8 flex-1">
        {# <fieldset class="fieldset">
          <legend class="fieldset-legend w-full flex justify-between items-center">
            <div class="font-light font-heading text-base md:text-lg">Programmes officiels couverts</div>
            <div class="relative">
              <div class="badge badge-outline badge-sm cursor-help peer">?</div>
              <div class="absolute bottom-full right-0 mb-2 px-3 py-2 bg-base-300 text-base-content text-sm rounded shadow-lg opacity-0 pointer-events-none peer-hover:opacity-100 peer-hover:pointer-events-auto transition-opacity duration-200 whitespace-nowrap z-50" style="font-weight: 300 !important">
                <strong>La majorité des questions relèvent du
                  <br />
                programme de 2<sup>nde</sup>.</strong>
                <br />
                <br />
                Restreindre ou non la sélection
                <br />
                des questions à celles des sujets 0
                <br />
                qui ne nécessitent pas (forcément)
                <br />
                le programme de 1<sup>ère</sup>.


              </div>
            </div>
          </legend>
          <div class="join">
            <input class="join-item btn btn-outline w-[50%] font-extralight" type="radio" name="options" aria-label="2nde" disabled />
            <input class="join-item btn btn-outline w-[50%] font-extralight" type="radio" name="options" aria-label="2nde & 1ère" disabled />
          </div>
          <p class="label" style="gap:0 !important">
            Obligatoire, restreindre ou non au programme de 2<sup>nde</sup>.
          </p>
</fieldset> #}

        <fieldset class="fieldset">
          <legend class="fieldset-legend w-full flex justify-between items-center">
            <div class="font-light font-heading text-base md:text-lg">Filière / Spécialité</div>
            <div class="relative">
              <div class="badge badge-outline badge-sm cursor-help peer">?</div>
              <div class="absolute bottom-full right-0 mb-2 px-3 py-2 bg-base-300 text-base-content text-sm rounded shadow-lg opacity-0 pointer-events-none peer-hover:opacity-100 peer-hover:pointer-events-auto transition-opacity duration-200 whitespace-nowrap z-50"
                   style="font-weight: 300 !important">
                Spé : Spécialité Maths
                <br />
                Non Spé : Enseignement Spécifique
                <br />
                Techno = Filière technologique
                <br />
                Détails disponibles sur le site du ministère,
                <br />
                liens dans la sections "Consulter les sujets 0".
              </div>
            </div>
          </legend>
          <div class="join">
            <input class="join-item btn w-[33.3%] font-light" type="radio" name="sujets0" aria-label="Spé." />
            <input class="join-item btn w-[33.3%] font-light"
                   type="radio"
                   name="sujets0"
                   aria-label="Non Spé."
                   disabled />
            <input class="join-item btn w-[33.3%] font-light" type="radio" name="sujets0" aria-label="Techno" disabled />
          </div>
          <p class="label">Obligatoire (choisir un programme officiel spécifique).</p>
        </fieldset>
      </div>
    </div>

    <fieldset class="fieldset">
      <!-- Button to execute all generators -->
      <div class="mt-4">
        <button id="execute-all-generators-btn"
                type="button"
                class="btn btn-primary btn-disabled w-full"
                disabled
                title="Waiting for Nagini to load...">
          <svg xmlns="http://www.w3.org/2000/svg"
               class="h-5 w-5 mr-2"
               viewBox="0 0 24 24"
               fill="none"
               stroke="currentColor"
               stroke-width="2"
               stroke-linecap="round"
               stroke-linejoin="round">
            <polygon points="5 3 19 12 5 21 5 3"></polygon>
          </svg>
          Générer
        </button>
      </div>
      {# <span class="ml-3 text-sm text-base-content/60">Exécute 3 générateurs de questions</span> #}
    </fieldset>
  </form>
</div>


<!-- Status message and progress bar that persists -->
<div id="generation-status" class="mt-6 p-4 bg-base-200 rounded-lg shadow-sm">
  <div class="flex flex-col gap-2">
    <div class="flex justify-between items-center">
      <div id="generation-message" class="font-medium">En attente de génération...</div>
      <div id="generation-time" class="text-sm opacity-70"></div>
    </div>
    <progress id="generation-progress" class="progress w-full" value="0" max="100"></progress>
    <div class="flex justify-end mt-2">
      <button id="print-current-copy-btn"
              onclick="printStudentCopy(generationResults.currentStudentIndex)"
              class="btn btn-sm btn-outline"
              disabled>Imprimer cette copie</button>
      <button id="print-all-copies-btn" onclick="printAllCopies()" class="btn btn-sm btn-outline ml-2" disabled>
        Imprimer toutes les copies
      </button>
    </div>
  </div>
</div>

<!-- Student pagination buttons for preview -->
<div id="student-pagination" class="flex flex-wrap gap-2 mt-4 mb-4 justify-center">
  <!-- Buttons will be dynamically added here -->
</div>

<!-- Print Instructions -->
<div class="alert alert-info mt-4 mb-4">
  <svg xmlns="http://www.w3.org/2000/svg"
       fill="none"
       viewBox="0 0 24 24"
       class="stroke-current shrink-0 w-6 h-6">
    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z">
    </path>
  </svg>
  <div>
    <h3 class="font-bold">Note d'impression</h3>
    <div class="text-xs">
      L'impression est configurée pour utiliser automatiquement les bonnes marges. Si Chrome affiche une boîte de dialogue, les marges devraient déjà être définies sur "Aucune".
    </div>
  </div>
</div>


<script>
    // Auto-select "Spé." radio button on page load
    document.addEventListener('DOMContentLoaded', function() {
        // Find and click the "Spé." radio button
        const speRadioButton = document.querySelector('input[type="radio"][name="sujets0"][aria-label="Spé."]');
        if (speRadioButton) {
            speRadioButton.checked = true;
            speRadioButton.click();
        }

        // Function to check and click the generate button when it's enabled
        function checkAndClickGenerateButton() {
            const generateButton = document.getElementById('execute-all-generators-btn');

            if (generateButton && !generateButton.disabled && !generateButton.classList.contains('btn-disabled')) {
                // Button is enabled, click it
                generateButton.click();
                console.log('Auto-clicked the Generate button');
            } else {
                // Button is still disabled, check again after a short delay
                setTimeout(checkAndClickGenerateButton, 500);
            }
        }

        // Start checking for the button to be enabled
        checkAndClickGenerateButton();
    });
</script>


<link rel="stylesheet"
      href="https://cdn.jsdelivr.net/gh/pointcarre-app/papyrus@v0.0.7/src/styles/index.css" />
<link rel="stylesheet"
      href="https://cdn.jsdelivr.net/gh/pointcarre-app/papyrus@v0.0.7/src/styles/print.css" />

<div class="font-heading text-lg sm:text-xl md:text-2xl mt-12 mb-4 flex items-center gap-2">
  Consulter les copies générées
</div>


<!-- Preview section for Papyrus documents -->
<div class="card bg-base-100 mt-4 mb-4 shadow">
  <div class="card-body">
    <!-- Debug toggle button in top right corner -->
    <div class="flex justify-end mb-2">
      <label class="swap swap-flip text-sm">
        <input type="checkbox" id="papyrus-debug-toggle" />
        <div class="swap-off flex items-center gap-1">
          <svg xmlns="http://www.w3.org/2000/svg"
               class="h-4 w-4"
               fill="none"
               viewBox="0 0 24 24"
               stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          Debug Off
        </div>
        <div class="swap-on flex items-center gap-1 text-primary">
          <svg xmlns="http://www.w3.org/2000/svg"
               class="h-4 w-4"
               fill="none"
               viewBox="0 0 24 24"
               stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          Debug On
        </div>
      </label>
    </div>
    <!-- Container for rendering Papyrus content -->
    <div id="pages-container"
         class="border rounded p-4 bg-white papyrus-document"
         style="min-height: 500px;
                overflow: auto">
      <!-- Content will be added here by Papyrus -->
    </div>
  </div>
</div>

<!-- Additional styles for consistent preview and print -->
<style>
    :root {
        /* Default document settings as CSS variables - will be overridden by JavaScript */
        /* IMPORTANT: These must match getDocumentSettings() in index-papyrus.js */
        --papyrus-margin-top: 3mm;
        /* Small top margin for breathing room */
        --papyrus-margin-right: 8mm;
        /* Side margins for readability */
        --papyrus-margin-bottom: 3mm;
        /* Reduced for more content space */
        --papyrus-margin-left: 8mm;
        /* Reduced for more content space */
        --papyrus-font-size-h1: 28px;
        --papyrus-font-size-h2: 24px;
        --papyrus-font-size-h3: 20px;
        --papyrus-font-size-h4: 18px;
        --papyrus-font-size-h5: 16px;
        --papyrus-font-size-h6: 14px;
        --papyrus-font-size-body: 15px;
    }

    /* Apply print styles to preview as well */
    .papyrus-document {
        font-family: 'Spectral', serif;
    }

    /* Papyrus page structure - CLEAR RESPONSIBILITY:
       - .page-wrapper: handles page dimensions and shadows (NO padding)
       - .page-preview: structural container (NO padding)  
       - .page-content: ONLY element with padding (document margins)
    */
    .page-wrapper {
        width: 210mm;
        min-height: 297mm;
        max-height: 297mm;
        margin: 0 auto 10mm auto;
        /* Only margin between pages */
        padding: 0 !important;
        /* NO padding here */
        background: white;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.12), 0 1px 2px rgba(0, 0, 0, 0.24);
        box-sizing: border-box;
        position: relative;
        overflow: hidden;
        page-break-after: always;
        page-break-inside: avoid;
    }

    .page-preview {
        width: 100%;
        height: 297mm;
        padding: 0 !important;
        /* NO padding here */
        margin: 0 !important;
        /* NO margin here */
        position: relative;
        box-sizing: border-box;
    }

    .page-content {
        /* ONLY this element handles document margins via padding */
        padding: var(--papyrus-margin-top) var(--papyrus-margin-right) var(--papyrus-margin-bottom) var(--papyrus-margin-left);
        height: 297mm;
        width: 210mm;
        box-sizing: border-box;
        overflow: hidden;
        position: relative;
    }

    /* Simple print settings */
    @page {
        margin: 0;
        size: A4;
    }

    @media print {
        .page-wrapper {
            margin: 0 !important;
            box-shadow: none !important;
            page-break-after: always;
        }

        .page-content {
            padding: var(--papyrus-margin-top) var(--papyrus-margin-right) var(--papyrus-margin-bottom) var(--papyrus-margin-left);
        }

        /* Ensure headings have no margins in print */
        h1,
        h2,
        h3,
        h4,
        h5,
        h6 {
            margin: 0 !important;
        }

        /* Ensure consistent spacing for all elements */
        #main-title {
            margin: 0 !important;
        }

        /* Remove any default paragraph margins */
        p {
            margin: 0;
        }
    }

    /* Apply font sizes from variables and remove default margins */
    .papyrus-document h1,
    .papyrus-document h2,
    .papyrus-document h3,
    .papyrus-document h4,
    .papyrus-document h5,
    .papyrus-document h6 {
        margin: 0;
        /* Remove all default heading margins */
    }

    .papyrus-document h1 {
        font-size: var(--papyrus-font-size-h1);
    }

    .papyrus-document h2 {
        font-size: var(--papyrus-font-size-h2);
    }

    .papyrus-document h3 {
        font-size: var(--papyrus-font-size-h3);
    }

    .papyrus-document h4 {
        font-size: var(--papyrus-font-size-h4);
    }

    .papyrus-document h5 {
        font-size: var(--papyrus-font-size-h5);
    }

    .papyrus-document h6 {
        font-size: var(--papyrus-font-size-h6);
    }

    .papyrus-document p,
    .papyrus-document div {
        font-size: var(--papyrus-font-size-body);
    }
</style>

<!-- Hidden textarea for JSON (required by papyrus) -->
<textarea id="json-input" style="display: none;"></textarea>

<!-- Hidden tabs container (required by DocumentManager) -->
<div id="document-tabs" style="display: none;"></div>


<!-- Collapsible section for detailed results -->
<div class="collapse collapse-arrow bg-base-200 w-full mt-12">
  <input type="checkbox" class="collapse-toggle" />
  <div class="collapse-title text-xs">Informations détaillées pour développeur</div>
  <div class="collapse-content">
    <div id="generator-results-wrapper" class="mt-2"></div>
  </div>
</div>
