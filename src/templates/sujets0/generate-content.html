<style>
    @media (max-width: 639px) {
        #nb-eleves {
            width: calc(100% - 40px - 40px);
        }

        #nb-questions {
            width: calc(100% - 40px - 40px);
        }
    }

    /* Error states for form fields */
    .input-error {
        border-color: hsl(var(--er)) !important;
        border-width: 2px !important;
    }

    .ring-2.ring-error {
        box-shadow: 0 0 0 2px hsl(var(--er)) !important;
        border-radius: 0.5rem;
    }

    /* Smooth transition for error states */
    .input,
    .join {
        transition: border-color 0.2s, box-shadow 0.2s;
    }

    /* Graph Rendering Styles  for v4pyjs */


    /* LaTeX Rendering Styles */
    .svg-latex {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 100%;
        height: 100%;
        padding: 0;
        box-sizing: border-box;
        border-radius: 0.25rem;
        font-size: 0.875rem;
    }

    foreignObject .katex {
        margin: 0 !important;
        padding: 0 !important;
        line-height: 1 !important;
        font-size: inherit !important;
        color: inherit !important;
        text-align: center;
    }

    foreignObject div {
        height: 100%;
        width: 100%;
        color: inherit !important;
    }

    /* Essential text size for graph labels */
    .text-2xs {
        font-size: 0.625rem !important;
        line-height: 1 !important;
    }
</style>


<div class="font-heading text-lg sm:text-xl md:text-2xl mt-12 mb-4 flex items-center gap-2">
  Configurer la génération d'exercices
</div>

<div class="flex card justify-center px-2 mt-0 sm:px-4 md:px-8 bg-base-200 shadow-sm">
  <form class="w-full my-4" id="arpege-form">
    <!-- Two main columns: numbers on left, radio buttons on right -->
    <div class="flex flex-col sm:flex-row gap-4 sm:gap-8">
      <!-- Left column: Number inputs -->
      <div class="flex flex-col gap-4 sm:gap-8 flex-1">
        <fieldset class="fieldset">
          <legend class="fieldset-legend w-full flex justify-between items-center">
            <div class="font-light font-heading text-base md:text-lg">Copies à générer</div>
            <div class="relative">
              <div class="badge badge-outline badge-sm cursor-help peer">?</div>
              <div class="absolute bottom-full right-0 mb-2 px-3 py-2 bg-base-300 text-base-content text-sm rounded shadow-lg opacity-0 pointer-events-none peer-hover:opacity-100 peer-hover:pointer-events-auto transition-opacity duration-200 whitespace-nowrap z-50"
                   style="font-weight: 300 !important">
                Toutes les copies utiliseront
                <br />
                les mêmes questions issues des sujets 0,
                <br />
                mais avec des valeurs aléatoires.
              </div>
            </div>
            <div class="relative hidden">
              <div class="badge badge-outline badge-sm cursor-help peer">?</div>
              <div class="absolute bottom-full right-0 mb-2 px-3 py-2 bg-base-300 text-base-content text-sm rounded shadow-lg opacity-0 pointer-events-none peer-hover:opacity-100 peer-hover:pointer-events-auto transition-opacity duration-200 whitespace-nowrap z-50"
                   style="font-weight: 300 !important">tooltiptext</div>
            </div>
          </legend>
          <div class="join w-full">
            <input type="number"
                   id="nb-eleves"
                   name="nb-eleves"
                   min="1"
                   max="50"
                   value="1"
                   required
                   class="input join-item w-full"
                   aria-describedby="nb-eleves-help" />
            <button type="button"
                    class="btn join-item"
                    onclick="document.getElementById('nb-eleves').stepDown()"
                    style="width:40px;
                           height:40px">-</button>
            <button type="button"
                    class="btn join-item"
                    onclick="document.getElementById('nb-eleves').stepUp()"
                    style="width:40px;
                           height:40px">+</button>
          </div>
          <p class="label">Obligatoire, entre 1 et 50.</p>
        </fieldset>

        <fieldset class="fieldset">
          <legend class="fieldset-legend w-full flex justify-between items-center">
            <div class="font-light font-heading text-base md:text-lg">Questions par copie</div>
            <div class="relative">
              <div class="badge badge-outline badge-sm cursor-help peer">?</div>
              <div class="absolute bottom-full right-0 mb-2 px-3 py-2 bg-base-300 text-base-content text-sm rounded shadow-lg opacity-0 pointer-events-none peer-hover:opacity-100 peer-hover:pointer-events-auto transition-opacity duration-200 whitespace-nowrap z-50"
                   style="font-weight: 300 !important">
                Nombre de questions
                <br />
                par copie (entre 1 et 12).
                <br />
                Une partie A d'un sujet 0 officiel
                <br />
                compte 12 questions.
              </div>
            </div>
          </legend>
          <div class="join w-full">
            <input type="number"
                   id="nb-questions"
                   name="nb-questions"
                   min="1"
                   max="12"
                   value="12"
                   required
                   class="input join-item w-full"
                   aria-describedby="nb-questions-help" />
            <button type="button" class="btn join-item" onclick="document.getElementById('nb-questions').stepDown()">
              -
            </button>
            <button type="button" class="btn join-item" onclick="document.getElementById('nb-questions').stepUp()">
              +
            </button>
          </div>
          <p class="label">Obligatoire, entre 1 et 12.</p>
        </fieldset>
      </div>

      <!-- Right column: Radio buttons -->
      <div class="flex flex-col gap-4 sm:gap-8 flex-1">
        {# <fieldset class="fieldset">
          <legend class="fieldset-legend w-full flex justify-between items-center">
            <div class="font-light font-heading text-base md:text-lg">Programmes officiels couverts</div>
            <div class="relative">
              <div class="badge badge-outline badge-sm cursor-help peer">?</div>
              <div class="absolute bottom-full right-0 mb-2 px-3 py-2 bg-base-300 text-base-content text-sm rounded shadow-lg opacity-0 pointer-events-none peer-hover:opacity-100 peer-hover:pointer-events-auto transition-opacity duration-200 whitespace-nowrap z-50" style="font-weight: 300 !important">
                <strong>La majorité des questions relèvent du
                  <br />
                programme de 2<sup>nde</sup>.</strong>
                <br />
                <br />
                Restreindre ou non la sélection
                <br />
                des questions à celles des sujets 0
                <br />
                qui ne nécessitent pas (forcément)
                <br />
                le programme de 1<sup>ère</sup>.


              </div>
            </div>
          </legend>
          <div class="join">
            <input class="join-item btn btn-outline w-[50%] font-extralight" type="radio" name="options" aria-label="2nde" disabled />
            <input class="join-item btn btn-outline w-[50%] font-extralight" type="radio" name="options" aria-label="2nde & 1ère" disabled />
          </div>
          <p class="label" style="gap:0 !important">
            Obligatoire, restreindre ou non au programme de 2<sup>nde</sup>.
          </p>
</fieldset> #}

        <fieldset class="fieldset">
          <legend class="fieldset-legend w-full flex justify-between items-center">
            <div class="font-light font-heading text-base md:text-lg">Filière / Spécialité</div>
            <div class="relative">
              <div class="badge badge-outline badge-sm cursor-help peer">?</div>
              <div class="absolute bottom-full right-0 mb-2 px-3 py-2 bg-base-300 text-base-content text-sm rounded shadow-lg opacity-0 pointer-events-none peer-hover:opacity-100 peer-hover:pointer-events-auto transition-opacity duration-200 whitespace-nowrap z-50"
                   style="font-weight: 300 !important">
                Spé : Spécialité Maths
                <br />
                Non Spé : Enseignement Spécifique
                <br />
                Techno = Filière technologique
                <br />
                Détails disponibles sur le site du ministère,
                <br />
                liens dans la sections "Consulter les sujets 0".
              </div>
            </div>
          </legend>
          <div class="join">
            <input class="join-item btn w-[33.3%] font-light" type="radio" name="sujets0" aria-label="Spé." />
            <input class="join-item btn w-[33.3%] font-light"
                   type="radio"
                   name="sujets0"
                   aria-label="Non Spé."
                   disabled />
            <input class="join-item btn w-[33.3%] font-light" type="radio" name="sujets0" aria-label="Techno" disabled />
          </div>
          <p class="label">Obligatoire (choisir un programme officiel spécifique).</p>
        </fieldset>
      </div>
    </div>

    <fieldset class="fieldset">
      <!-- Button to execute all generators -->
      <div class="mt-4">
        <button id="execute-all-generators-btn"
                type="button"
                class="btn btn-primary btn-disabled w-full"
                disabled
                title="Waiting for Nagini to load...">
          <svg xmlns="http://www.w3.org/2000/svg"
               class="h-5 w-5 mr-2"
               viewBox="0 0 24 24"
               fill="none"
               stroke="currentColor"
               stroke-width="2"
               stroke-linecap="round"
               stroke-linejoin="round">
            <polygon points="5 3 19 12 5 21 5 3"></polygon>
          </svg>
          Générer
        </button>
      </div>
      {# <span class="ml-3 text-sm text-base-content/60">Exécute 3 générateurs de questions</span> #}
    </fieldset>
  </form>
</div>


<!-- Status message and progress bar that persists -->
<div id="generation-status" class="mt-6 p-4 bg-base-200 rounded-lg shadow-sm">
  <div class="flex flex-col gap-2">
    <div class="flex justify-between items-center">
      <div id="generation-message" class="font-medium">En attente de génération...</div>
      <div id="generation-time" class="text-sm opacity-70"></div>
    </div>
    <progress id="generation-progress" class="progress w-full" value="0" max="100"></progress>
  </div>
</div>

<!-- Collapsible section for detailed results -->
<div class="collapse collapse-arrow bg-base-200 w-full mt-4">
  <input type="checkbox" class="collapse-toggle" />
  <div class="collapse-title">Afficher le détail par copie</div>
  <div class="collapse-content">
    <div id="generator-results-wrapper" class="mt-2"></div>
  </div>
</div>


{# Temporary #}
<script>
    // Auto-select "Spé." radio button on page load
    document.addEventListener('DOMContentLoaded', function() {
        // Find and click the "Spé." radio button
        const speRadioButton = document.querySelector('input[type="radio"][name="sujets0"][aria-label="Spé."]');
        if (speRadioButton) {
            speRadioButton.checked = true;
            speRadioButton.click();
        }

        // Function to check and click the generate button when it's enabled
        function checkAndClickGenerateButton() {
            const generateButton = document.getElementById('execute-all-generators-btn');

            if (generateButton && !generateButton.disabled && !generateButton.classList.contains('btn-disabled')) {
                // Button is enabled, click it
                generateButton.click();
                console.log('Auto-clicked the Generate button');
            } else {
                // Button is still disabled, check again after a short delay
                setTimeout(checkAndClickGenerateButton, 500);
            }
        }

        // Start checking for the button to be enabled
        checkAndClickGenerateButton();
    });
</script>
