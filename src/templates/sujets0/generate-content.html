<style>
    @media (max-width: 639px) {
        #nb-eleves {
            width: calc(100% - 40px - 40px);
        }

        #nb-questions {
            width: calc(100% - 40px - 40px);
        }
    }

    /* Error states for form fields */
    .input-error {
        border-color: hsl(var(--er)) !important;
        border-width: 2px !important;
    }

    .ring-2.ring-error {
        box-shadow: 0 0 0 2px hsl(var(--er)) !important;
        border-radius: 0.5rem;
    }

    /* Smooth transition for error states */
    .input,
    .join {
        transition: border-color 0.2s, box-shadow 0.2s;
    }

    /* Graph Rendering Styles  for v4pyjs */


    /* LaTeX Rendering Styles */
    .svg-latex {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 100%;
        height: 100%;
        padding: 0;
        box-sizing: border-box;
        border-radius: 0.25rem;
        font-size: 0.875rem;
    }

    foreignObject .katex {
        margin: 0 !important;
        padding: 0 !important;
        line-height: 1 !important;
        font-size: inherit !important;
        color: inherit !important;
        text-align: center;
    }

    foreignObject div {
        height: 100%;
        width: 100%;
        color: inherit !important;
    }

    /* Essential text size for graph labels */
    .text-2xs {
        font-size: 0.625rem !important;
        line-height: 1 !important;
    }
</style>


<div class="font-heading text-lg sm:text-xl md:text-2xl mt-12 mb-4 flex items-center gap-2">
  Configurer la génération d'exercices
</div>

<div class="flex card justify-center px-2 mt-0 sm:px-4 md:px-8 bg-base-200 shadow-sm">
  <form class="w-full my-4" id="arpege-form">
    <!-- Two main columns: numbers on left, radio buttons on right -->
    <div class="flex flex-col sm:flex-row gap-4 sm:gap-8">
      <!-- Left column: Number inputs -->
      <div class="flex flex-col gap-4 sm:gap-8 flex-1">
        <fieldset class="fieldset">
          <legend class="fieldset-legend w-full flex justify-between items-center">
            <div class="font-light font-heading text-base md:text-lg">Copies à générer</div>
            <div class="relative">
              <div class="badge badge-outline badge-sm cursor-help peer">?</div>
              <div class="absolute bottom-full right-0 mb-2 px-3 py-2 bg-base-300 text-base-content text-sm rounded shadow-lg opacity-0 pointer-events-none peer-hover:opacity-100 peer-hover:pointer-events-auto transition-opacity duration-200 whitespace-nowrap z-50"
                   style="font-weight: 300 !important">
                Toutes les copies utiliseront
                <br />
                les mêmes questions issues des sujets 0,
                <br />
                mais avec des valeurs aléatoires.
              </div>
            </div>
            <div class="relative hidden">
              <div class="badge badge-outline badge-sm cursor-help peer">?</div>
              <div class="absolute bottom-full right-0 mb-2 px-3 py-2 bg-base-300 text-base-content text-sm rounded shadow-lg opacity-0 pointer-events-none peer-hover:opacity-100 peer-hover:pointer-events-auto transition-opacity duration-200 whitespace-nowrap z-50"
                   style="font-weight: 300 !important">tooltiptext</div>
            </div>
          </legend>
          <div class="join w-full">
            <input type="number"
                   id="nb-eleves"
                   name="nb-eleves"
                   min="1"
                   max="50"
                   value="1"
                   required
                   class="input join-item w-full"
                   aria-describedby="nb-eleves-help" />
            <button type="button"
                    class="btn join-item"
                    onclick="document.getElementById('nb-eleves').stepDown()"
                    style="width:40px;
                           height:40px">-</button>
            <button type="button"
                    class="btn join-item"
                    onclick="document.getElementById('nb-eleves').stepUp()"
                    style="width:40px;
                           height:40px">+</button>
          </div>
          <p class="label">Obligatoire, entre 1 et 50.</p>
        </fieldset>

        <fieldset class="fieldset">
          <legend class="fieldset-legend w-full flex justify-between items-center">
            <div class="font-light font-heading text-base md:text-lg">Questions par copie</div>
            <div class="relative">
              <div class="badge badge-outline badge-sm cursor-help peer">?</div>
              <div class="absolute bottom-full right-0 mb-2 px-3 py-2 bg-base-300 text-base-content text-sm rounded shadow-lg opacity-0 pointer-events-none peer-hover:opacity-100 peer-hover:pointer-events-auto transition-opacity duration-200 whitespace-nowrap z-50"
                   style="font-weight: 300 !important">
                Nombre de questions
                <br />
                par copie (entre 1 et 12).
                <br />
                Une partie A d'un sujet 0 officiel
                <br />
                compte 12 questions.
              </div>
            </div>
          </legend>
          <div class="join w-full">
            <input type="number"
                   id="nb-questions"
                   name="nb-questions"
                   min="1"
                   max="12"
                   value="12"
                   required
                   class="input join-item w-full"
                   aria-describedby="nb-questions-help" />
            <button type="button" class="btn join-item" onclick="document.getElementById('nb-questions').stepDown()">
              -
            </button>
            <button type="button" class="btn join-item" onclick="document.getElementById('nb-questions').stepUp()">
              +
            </button>
          </div>
          <p class="label">Obligatoire, entre 1 et 12.</p>
        </fieldset>
      </div>

      <!-- Right column: Radio buttons -->
      <div class="flex flex-col gap-4 sm:gap-8 flex-1">
        {# <fieldset class="fieldset">
          <legend class="fieldset-legend w-full flex justify-between items-center">
            <div class="font-light font-heading text-base md:text-lg">Programmes officiels couverts</div>
            <div class="relative">
              <div class="badge badge-outline badge-sm cursor-help peer">?</div>
              <div class="absolute bottom-full right-0 mb-2 px-3 py-2 bg-base-300 text-base-content text-sm rounded shadow-lg opacity-0 pointer-events-none peer-hover:opacity-100 peer-hover:pointer-events-auto transition-opacity duration-200 whitespace-nowrap z-50" style="font-weight: 300 !important">
                <strong>La majorité des questions relèvent du
                  <br />
                programme de 2<sup>nde</sup>.</strong>
                <br />
                <br />
                Restreindre ou non la sélection
                <br />
                des questions à celles des sujets 0
                <br />
                qui ne nécessitent pas (forcément)
                <br />
                le programme de 1<sup>ère</sup>.


              </div>
            </div>
          </legend>
          <div class="join">
            <input class="join-item btn btn-outline w-[50%] font-extralight" type="radio" name="options" aria-label="2nde" disabled />
            <input class="join-item btn btn-outline w-[50%] font-extralight" type="radio" name="options" aria-label="2nde & 1ère" disabled />
          </div>
          <p class="label" style="gap:0 !important">
            Obligatoire, restreindre ou non au programme de 2<sup>nde</sup>.
          </p>
</fieldset> #}

        <fieldset class="fieldset">
          <legend class="fieldset-legend w-full flex justify-between items-center">
            <div class="font-light font-heading text-base md:text-lg">Filière / Spécialité</div>
            <div class="relative">
              <div class="badge badge-outline badge-sm cursor-help peer">?</div>
              <div class="absolute bottom-full right-0 mb-2 px-3 py-2 bg-base-300 text-base-content text-sm rounded shadow-lg opacity-0 pointer-events-none peer-hover:opacity-100 peer-hover:pointer-events-auto transition-opacity duration-200 whitespace-nowrap z-50"
                   style="font-weight: 300 !important">
                Spé : Spécialité Maths
                <br />
                Non Spé : Enseignement Spécifique
                <br />
                Techno = Filière technologique
                <br />
                Détails disponibles sur le site du ministère,
                <br />
                liens dans la sections "Consulter les sujets 0".
              </div>
            </div>
          </legend>
          <div class="join">
            <input class="join-item btn w-[33.3%] font-light" type="radio" name="sujets0" aria-label="Spé." />
            <input class="join-item btn w-[33.3%] font-light"
                   type="radio"
                   name="sujets0"
                   aria-label="Non Spé."
                   disabled />
            <input class="join-item btn w-[33.3%] font-light" type="radio" name="sujets0" aria-label="Techno" disabled />
          </div>
          <p class="label">Obligatoire (choisir un programme officiel spécifique).</p>
        </fieldset>
      </div>
    </div>

    <fieldset class="fieldset">
      <!-- Button to execute all generators -->
      <div class="mt-4">
        <button id="execute-all-generators-btn"
                type="button"
                class="btn btn-primary btn-disabled w-full"
                disabled
                title="Waiting for Nagini to load...">
          <svg xmlns="http://www.w3.org/2000/svg"
               class="h-5 w-5 mr-2"
               viewBox="0 0 24 24"
               fill="none"
               stroke="currentColor"
               stroke-width="2"
               stroke-linecap="round"
               stroke-linejoin="round">
            <polygon points="5 3 19 12 5 21 5 3"></polygon>
          </svg>
          Générer
        </button>
      </div>
      {# <span class="ml-3 text-sm text-base-content/60">Exécute 3 générateurs de questions</span> #}
    </fieldset>
  </form>
</div>


<!-- Status message and progress bar that persists -->
<div id="generation-status" class="mt-6 p-4 bg-base-200 rounded-lg shadow-sm">
  <div class="flex flex-col gap-2">
    <div class="flex justify-between items-center">
      <div id="generation-message" class="font-medium">En attente de génération...</div>
      <div id="generation-time" class="text-sm opacity-70"></div>
    </div>
    <progress id="generation-progress" class="progress w-full" value="0" max="100"></progress>
    <div class="flex justify-end mt-2">
      <button id="print-current-copy-btn" onclick="printCurrentCopy()" class="btn btn-sm btn-outline" disabled>
        Imprimer cette copie
      </button>
      <button id="print-all-copies-btn" onclick="printAllCopies()" class="btn btn-sm btn-outline ml-2" disabled>
        Imprimer toutes les copies
      </button>
    </div>
  </div>
</div>

<!-- Collapsible section for detailed results -->
<div class="collapse collapse-arrow bg-base-200 w-full mt-4">
  <input type="checkbox" class="collapse-toggle" />
  <div class="collapse-title">Afficher le détail par copie</div>
  <div class="collapse-content">
    <div id="generator-results-wrapper" class="mt-2"></div>
  </div>
</div>


{# Temporary #}
<script>
    // Auto-select "Spé." radio button on page load
    document.addEventListener('DOMContentLoaded', function() {
        // Find and click the "Spé." radio button
        const speRadioButton = document.querySelector('input[type="radio"][name="sujets0"][aria-label="Spé."]');
        if (speRadioButton) {
            speRadioButton.checked = true;
            speRadioButton.click();
        }

        // Function to check and click the generate button when it's enabled
        function checkAndClickGenerateButton() {
            const generateButton = document.getElementById('execute-all-generators-btn');

            if (generateButton && !generateButton.disabled && !generateButton.classList.contains('btn-disabled')) {
                // Button is enabled, click it
                generateButton.click();
                console.log('Auto-clicked the Generate button');
            } else {
                // Button is still disabled, check again after a short delay
                setTimeout(checkAndClickGenerateButton, 500);
            }
        }

        // Start checking for the button to be enabled
        checkAndClickGenerateButton();
    });
</script>


<link rel="stylesheet"
      href="https://cdn.jsdelivr.net/gh/pointcarre-app/papyrus@v0.0.1/src/styles/index.css" />
<link rel="stylesheet"
      href="https://cdn.jsdelivr.net/gh/pointcarre-app/papyrus@v0.0.1/src/styles/print.css" />


<!-- PDF Preview section with pagination -->
<div class="mt-6 p-4 bg-base-200 rounded-lg shadow-sm">
  <div class="flex justify-between items-center mb-4">
    <h3 class="font-medium">Aperçu des copies</h3>
    <div id="student-pagination" class="btn-group"></div>
  </div>

  <!-- Papyrus rendering container (now visible) -->
  <div id="pages-container" class="border border-base-300 rounded-lg bg-white p-4 min-h-[400px]">
  </div>
</div>

<!-- Hidden textarea for JSON (required by papyrus) -->
<textarea id="json-input" style="display: none;"></textarea>

<!-- Hidden tabs container (required by DocumentManager) -->
<div id="document-tabs" style="display: none;"></div>

<script type="module">
    // Import PCA Papyrus modules
    import {
        generatePages
    } from 'https://cdn.jsdelivr.net/gh/pointcarre-app/papyrus@v0.0.1/src/core/preview/index.js';
    import {
        printPage
    } from 'https://cdn.jsdelivr.net/gh/pointcarre-app/papyrus@v0.0.1/src/core/print-manager.js';
    import {
        initializeMargins,
        setMargins
    } from 'https://cdn.jsdelivr.net/gh/pointcarre-app/papyrus@v0.0.1/src/core/margin-config.js';
    import {
        initializeFontSizes,
        setFontSizes
    } from 'https://cdn.jsdelivr.net/gh/pointcarre-app/papyrus@v0.0.1/src/core/font-config.js';
    import {
        initializeSpaceBetweenDivs,
        setSpaceBetweenDivs
    } from 'https://cdn.jsdelivr.net/gh/pointcarre-app/papyrus@v0.0.1/src/core/margin-config.js';



    //
    //[
    //{
    //"id": "header-section",
    //"html": "<table style='width: 100%; border-collapse: collapse; border: 0.5px solid #e0e0e0; '><tr><td style='border: 0.5px solid #e0e0e0; padding: 2mm; vertical-align: middle; width: 50%;'>Nom :</td><td style='border: 0.5px solid #e0e0e0; padding: 2mm; vertical-align: middle; width: 25%;'>Classe :</td><td style='border: 0.5px solid #e0e0e0; padding: 2mm; vertical-align: middle; width: 25%;'>BolzanoBleu</td></tr><tr><td style='border: 0.5px solid #e0e0e0; padding: 2mm; vertical-align: middle; width: 50%;'>Prénom :</td><td style='border: 0.5px solid #e0e0e0; padding: 2mm; vertical-align: middle; width: 25%;'>Date :</td><td style='border: 0.5px solid #e0e0e0; padding: 2mm; vertical-align: middle; width: 25%;'>2nde&1ère|Spé</td></tr></table>",
    //"classes": [
    //"font-mono"
    //],
    //"style": "",
    //"isPapyrusHeader": true
    //},
    //{
    //"id": "main-title",
    //"html": "<div>Bac 1ère Spé. Maths : Partie 1 automatismes</div>",
    //"classes": [],
    //"style": "font-family: 'Spectral', serif; font-size: 24px; font-weight: bold; text-align: left; color: #2c3e50;"
    //},
    //{
    //"id": "subtitle",
    //"html": "<div>Questions inspirées des Sujets 0</div>",
    //"classes": [],
    //"style": "font-family: 'Spectral', serif; font-size: 18px; font-weight: 500; text-align: left; color: #5a6c7d; font-style: italic;"
    //},
    //{
    //"id": "question-1",
    //"html": "<div><div>1) Quel est l'inverse du quintuple de $7$ ?</div><div></div></div>",
    //"classes": [],
    //"style": ""
    //},
    //{
    //"id": "question-2",
    //"html": "<div><div>2) On considère la relation $F=a+\\dfrac{b}{cd}$. Lorsque $a=\\dfrac{1}{7}$, $b = 7$, $c = 1$, $d = -\\dfrac{1}{5}$, quelle est la valeur de $F$ ?</div><div></div></div>",
    //"classes": [],
    //"style": ""
    //},
    //{
    //"id": "question-3",
    //"html": "<div><div>3) Le prix d'un article est multiplié par $1,495$. De combien de pourcent le prix de cet article a-t-il augmenté ?</div><div></div></div>",
    //"classes": [],
    //"style": ""
    //},
    //{
    //"id": "question-4",
    //"html": "<div style='display: flex; gap: 20px; align-items: flex-start;'><div style='flex: 1;'>4) Le prix d'un article est noté $P$. Ce prix augmente de $65\\%$ puis diminue de $65\\%$. A l'issue de ces deux variations, de combien le prix a-t-il varié en pourcentage ?<br /><br />Référez-vous au graphique de la fonction carré ci-contre pour visualiser la croissance quadratique.</div><div style='flex: 0 0 250px;'><svg width='250' height='150' xmlns='http://www.w3.org/2000/svg' style='border: 1px solid #ddd; background: #f9f9f9;'><defs><marker id='arrowhead' markerWidth='6' markerHeight='4' refX='6' refY='2' orient='auto'><polygon points='0 0, 6 2, 0 4' fill='#333' /></marker></defs><!-- X axis --><line x1='20' y1='110' x2='230' y2='110' stroke='#333' stroke-width='1' marker-end='url(#arrowhead)' /><!-- Y axis --><line x1='125' y1='140' x2='125' y2='10' stroke='#333' stroke-width='1' marker-end='url(#arrowhead)' /><!-- Grid marks --><line x1='95' y1='108' x2='95' y2='112' stroke='#666' stroke-width='0.5' /><line x1='155' y1='108' x2='155' y2='112' stroke='#666' stroke-width='0.5' /><line x1='123' y1='90' x2='127' y2='90' stroke='#666' stroke-width='0.5' /><line x1='123' y1='50' x2='127' y2='50' stroke='#666' stroke-width='0.5' /><!-- Actual square function y = x² points: (-2,4), (-1,1), (0,0), (1,1), (2,4) scaled --><path d='M 65 140 L 80 125 L 95 115 L 110 110.5 L 125 110 L 140 110.5 L 155 115 L 170 125 L 185 140' stroke='#e74c3c' stroke-width='2' fill='none' /><!-- LaTeX labels using foreignObject --><foreignObject x='232' y='112' width='15' height='15'><div xmlns='http://www.w3.org/1999/xhtml' style='font-size: 12px;'>$x$</div></foreignObject><foreignObject x='128' y='8' width='15' height='15'><div xmlns='http://www.w3.org/1999/xhtml' style='font-size: 12px;'>$y$</div></foreignObject><!-- Origin --><circle cx='125' cy='110' r='1.5' fill='#333' /></svg></div></div>",
    //"classes": [],
    //"style": ""
    //},
    //{
    //"id": "question-5",
    //"html": "<div><div>5) On lance un dé à 4 faces. La probabilité d'obtenir chacune des faces est donnée dans le tableau suivant:<br />- Face numéro 1: $\\dfrac{13}{24}$<br />- Face numéro 2: $\\dfrac{13}{24}$<br />- Face numéro 3: $\\dfrac{13}{24}$<br />- Face numéro 4: $x$</div><div></div></div>",
    //"classes": [],
    //"style": ""
    //},
    //{
    //"id": "question-6",
    //"html": "<div><div>6) On considère $x$, $y$, et $u$ des réels non nuls tels que $\\dfrac{1}{x}+ \\dfrac{1}{y} = \\dfrac{1}{u}$. Exprimer $u$ en fonction $x$ et $y$.</div><div></div></div>",
    //"classes": [],
    //"style": ""
    //},
    //{
    //"id": "question-7",
    //"html": "<div><div>7) On a représenté ci-contre la parabole d'équation $y = x^2$. On note (J) l'inéquation, sur $\\mathbb{R}$, $x^{2} > 49$. Donner la ou les inéquation(s) du premier degré équivalente à J.</div><div></div></div>",
    //"classes": [],
    //"style": ""
    //},
    //{
    //"id": "question-8",
    //"html": "<div><div>8) On a représenté ci-contre une droite D dans un repère orthonormé. Donner l'équation de la droite D sous la forme $y=ax+b$</div><div></div></div>",
    //"classes": [],
    //"style": ""
    //},
    //{
    //"id": "question-9",
    //"html": "<div><div>9) Parmi les 3 fonctions $$f1: x \\mapsto x^{2} -\\left(x + 2\\right)^{2}$$, $$f2: x \\mapsto \\dfrac{1}{7}x --9 + \\dfrac{1}{5^{\\dfrac{1}{2}}}$$, $$f3: x \\mapsto \\dfrac{\\dfrac{9}{8}x + 2}{0,5}$$ Au sein des fonctions affines parmis $f1, f2, f3$, quel est le coefficient directeur avec la plus grande valeur absolue ?</div><div></div></div>",
    //"classes": [],
    //"style": ""
    //},
    //{
    //"id": "question-10",
    //"html": "<div><div>10) La courbe ci-contre représente la courbe d'équation $ax^2 + bx + c$. On suppose $\\lvert a \\rvert = 1$. Donner l'équation de la parabole.</div><div></div></div>",
    //"classes": [],
    //"style": ""
    //},
    //{
    //"id": "question-11",
    //"html": "<div><div>11) On a représenté ci-contre la courbe $\\mathcal{C}$ d'une fonction ${f}$. On note $A$ le point d'abscisse $x_A=-2$ tel que le point appartienne à la courbe $\\mathcal{C}$. Ecrire l'inégalité correcte de la forme $x\\times f(x) ? 0$</div><div></div></div>",
    //"classes": [],
    //"style": ""
    //},
    //{
    //"id": "question-12",
    //"html": "<div><div>12) Voici une série de notes avec les coefficients associés<br />-12 coefficient 3<br />-13 coefficient 5<br />-1 coefficient $x$<br />On note $m$ la moyenne de cette série. Que doit valoir $x$ pour que $m = 8.75$ ?</div><div></div></div>",
    //"classes": [],
    //"style": ""
    //}
    //]

    // Your JSON data
    const myDocumentData = [{
        "id": "header",
        "html": "<div>My Document Header</div>",
        "isPapyrusHeader": true
    }, {
        "id": "content",
        "html": "<div>My content with $\\sqrt{2}$ math</div>"
    }];

    // Initialize PCA Papyrus
    async function initPapyrus() {
        // Initialize configurations
        initializeMargins();
        initializeFontSizes();
        initializeSpaceBetweenDivs();

        // Optional: Set custom margins (in mm)
        setMargins({
            top: 15,
            right: 15,
            bottom: 15,
            left: 15
        });

        // Optional: Set custom font sizes (in px)
        setFontSizes({
            h1: 28,
            h2: 24,
            h3: 20,
            h4: 18,
            h5: 16,
            h6: 14,
            body: 12
        });

        // Set the JSON data
        document.getElementById('json-input').value = JSON.stringify(myDocumentData);

        // Generate preview (this populates #pages-container)
        generatePages();

        // Wait for rendering
        await new Promise(resolve => setTimeout(resolve, 500));

        // Optional: Show the preview
        document.getElementById('pages-container').style.display = 'block';

        // Auto-print or trigger print programmatically
        // printPage();
    }

    // Initialize on load
    window.addEventListener('load', initPapyrus);

    // Expose print function globally for button clicks
    window.printMyDocument = () => {
        printPage();
    };
</script>

<!-- Optional: Add a print button -->
<button onclick="printMyDocument()">Generate PDF</button>
