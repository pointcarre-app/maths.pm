{% extends "base/main-alt.html" %}

{% block title %}
  Settings - Configuration compl√®te
{% endblock title %}

{% block content %}
  <div class="py-8">
    <!-- Header -->
    <div class="text-center mb-8">
      <h1 class="text-4xl font-bold text-primary mb-2">‚öôÔ∏è Configuration Unifi√©e</h1>
      <p class="text-base-content/70">Tous les param√®tres du domaine et des produits</p>

      <!-- Quick Stats -->
      <div class="stats stats-horizontal shadow-sm bg-base-200 mt-4">
        <div class="stat">
          <div class="stat-figure text-primary">üåê</div>
          <div class="stat-title text-xs">Domaine</div>
          <div class="stat-value text-sm">
            {{ DOMAIN_CONFIG.domain_url.replace('https://', '').replace('http://', '') or 'N/A' }}
          </div>
        </div>

        <div class="stat">
          <div class="stat-figure text-secondary">üì¶</div>
          <div class="stat-title text-xs">Produits</div>
          <div class="stat-value text-sm">{{ products|length }}</div>
          <div class="stat-desc text-xs">charg√©s</div>
        </div>

        <div class="stat">
          <div class="stat-figure text-accent">‚öôÔ∏è</div>
          <div class="stat-title text-xs">Total Settings</div>
          <div class="stat-value text-sm">{{ unified_settings|length }}</div>
          <div class="stat-desc text-xs">param√®tres</div>
        </div>

        <div class="stat">
          <div class="stat-figure text-info">üìä</div>
          <div class="stat-title text-xs">Domain / Product</div>
          <div class="stat-value text-sm">
            {{ unified_settings|selectattr('type', 'eq', 'domain') |list|length }} /
            {{ unified_settings|selectattr('type', 'eq', 'product') |list|length }}
          </div>
          <div class="stat-desc text-xs">r√©partition</div>
        </div>
      </div>
    </div>

    <!-- Legend -->
    <div class="card bg-base-200 shadow-sm mb-6">
      <div class="card-body py-4">
        <div class="flex flex-wrap gap-4 text-sm">
          <div class="flex items-center gap-2">
            <div class="badge badge-primary">domain</div>
            <span>Param√®tres du domaine (maths.pm)</span>
          </div>
          <div class="flex items-center gap-2">
            <div class="badge badge-secondary">product</div>
            <span>Param√®tres sp√©cifiques aux produits</span>
          </div>
          <div class="flex items-center gap-2">
            <div class="badge badge-info badge-outline">Cat√©gorie</div>
            <span>Type de param√®tre (metatags, backend, etc.)</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Main Unified Settings Table -->
    <div class="card bg-base-100 shadow-sm">
      <div class="card-body">
        <h2 class="card-title text-lg mb-4">üîç Tableau Unifi√© des Param√®tres</h2>

        <!-- Filters -->
        <div class="mb-4 flex flex-wrap gap-2">
          <button class="btn btn-xs btn-outline" onclick="filterTable('all')">Tout afficher</button>
          <button class="btn btn-xs btn-primary" onclick="filterTable('domain')">Domain uniquement</button>
          <button class="btn btn-xs btn-secondary" onclick="filterTable('product')">
            Products uniquement
          </button>
          <div class="divider divider-horizontal">ou</div>
          <button class="btn btn-xs btn-info" onclick="filterCategory('metatags')">Metatags</button>
          <button class="btn btn-xs btn-warning" onclick="filterCategory('backend_settings')">
            Backend
          </button>
          <button class="btn btn-xs btn-success" onclick="filterCategory('templating')">Templates</button>
        </div>

        <div class="overflow-x-auto">
          <table class="table table-zebra table-xs">
            <thead>
              <tr>
                <th class="w-20">Type</th>
                <th class="w-32">Source</th>
                <th class="w-28">Cat√©gorie</th>
                <th class="w-40">Cl√©</th>
                <th>Valeur</th>
                <th class="w-48">Utilis√© dans</th>
                <th class="w-40">Description</th>
              </tr>
            </thead>
            <tbody>
              {% for setting in unified_settings %}
                <tr class="hover setting-row" data-type="{{ setting.type }}" data-category="{{ setting.category }}">
                  <td>
                    {% if setting.type == 'domain' %}
                      <div class="badge badge-primary badge-sm">{{ setting.type }}</div>
                    {% else %}
                      <div class="badge badge-secondary badge-sm">{{ setting.type }}</div>
                    {% endif %}
                  </td>
                  <td>
                    <code class="text-xs text-base-content/70">{{ setting.source }}</code>
                  </td>
                  <td>
                    <div class="badge badge-info badge-outline badge-xs">{{ setting.category }}</div>
                  </td>
                  <td>
                    <code class="font-mono text-xs font-bold">{{ setting.key }}</code>
                  </td>
                  <td class="max-w-xs">
                    {% if setting.value is mapping %}
                      <details class="collapse collapse-arrow bg-base-200">
                        <summary class="collapse-title text-xs font-medium p-1">
                          Object ({{ setting.value|length }} keys)
                        </summary>
                        <div class="collapse-content">
                          <pre class="text-xs bg-base-300 p-2 rounded overflow-x-auto">{{ setting.value|tojson(indent=2) }}</pre>
                        </div>
                      </details>
                    {% elif setting.value is sequence and setting.value is not string %}
                      <details class="collapse collapse-arrow bg-base-200">
                        <summary class="collapse-title text-xs font-medium p-1">
                          Array ({{ setting.value|length }} items)
                        </summary>
                        <div class="collapse-content">
                          <pre class="text-xs bg-base-300 p-2 rounded overflow-x-auto">{{ setting.value|tojson(indent=2) }}</pre>
                        </div>
                      </details>
                    {% elif setting.value|string|length > 60 %}
                      <details class="collapse collapse-arrow bg-base-200">
                        <summary class="collapse-title text-xs font-medium p-1">
                          {{ setting.value|string|truncate(60) }}
                        </summary>
                        <div class="collapse-content">
                          <div class="text-xs bg-base-300 p-2 rounded whitespace-pre-wrap">{{ setting.value }}</div>
                        </div>
                      </details>
                    {% else %}
                      <span class="text-xs">{{ setting.value }}</span>
                    {% endif %}
                  </td>
                  <td>
                    <div class="text-xs text-base-content/70">{{ setting.used_in }}</div>
                  </td>
                  <td>
                    <div class="text-xs text-base-content/60 italic">{{ setting.description }}</div>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <!-- Summary -->
        <div class="mt-6 p-4 bg-base-200 rounded-lg">
          <h3 class="font-semibold mb-2">üìä R√©sum√©</h3>
          <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
            <div>
              <span class="font-medium">Param√®tres domaine:</span>
              <span class="ml-2 badge badge-primary badge-sm">
                {{ unified_settings|selectattr('type', 'eq', 'domain') |list|length }}
              </span>
            </div>
            <div>
              <span class="font-medium">Param√®tres produits:</span>
              <span class="ml-2 badge badge-secondary badge-sm">
                {{ unified_settings|selectattr('type', 'eq', 'product') |list|length }}
              </span>
            </div>
            <div>
              <span class="font-medium">Metatags:</span>
              <span class="ml-2 badge badge-info badge-sm">
                {{ unified_settings|selectattr('category', 'in', ['domain_specific_metatags', 'index_view_specific_metatags', 'metatags']) |list|length }}
              </span>
            </div>
            <div>
              <span class="font-medium">Backend:</span>
              <span class="ml-2 badge badge-warning badge-sm">
                {{ unified_settings|selectattr('category', 'eq', 'backend_settings') |list|length }}
              </span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Products Quick Reference -->
    <div class="card bg-base-100 shadow-sm mt-6">
      <div class="card-body">
        <h2 class="card-title text-lg mb-4">üì¶ R√©f√©rence Rapide des Produits</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
          {% for product in products %}
            <div class="card bg-base-200 shadow-sm">
              <div class="card-body p-4">
                <h3 class="font-mono font-bold text-sm">{{ product.name }}</h3>
                <div class="text-xs text-base-content/70">{{ product.title_html|safe }}</div>
                {% if product.local_path %}
                  <div class="mt-2">
                    <code class="text-xs bg-base-300 px-1 py-0.5 rounded">{{ product.local_path }}</code>
                  </div>
                {% endif %}
                <div class="flex gap-2 mt-2">
                  {% if product.backend_settings %}
                    <div class="badge badge-warning badge-xs">backend ‚úì</div>
                  {% endif %}
                  {% if product.metatags %}<div class="badge badge-info badge-xs">metatags ‚úì</div>{% endif %}
                </div>
              </div>
            </div>
          {% endfor %}
        </div>
      </div>
    </div>

    <!-- Navigation -->
    <div class="text-center mt-8">
      <a href="{{ url_for('index') }}" class="btn btn-primary btn-sm">‚Üê Retour √† l'accueil</a>
      <a href="{{ url_for('get_public_settings') }}" class="btn btn-outline btn-sm ml-2" target="_blank">API JSON</a>
    </div>
  </div>
{% endblock content %}

{% block extra_head %}
  <style>
      /* Custom styling for better readability */
      .table td {
          vertical-align: top;
      }

      .table code {
          background-color: hsl(var(--b2));
          padding: 0.125rem 0.25rem;
          border-radius: 0.25rem;
      }

      pre {
          white-space: pre-wrap;
          word-break: break-all;
      }

      .setting-row {
          transition: all 0.2s ease;
      }

      .setting-row.hidden {
          display: none;
      }

      .collapse-title {
          min-height: unset !important;
          padding: 0.25rem 0.5rem !important;
      }

      .collapse-content {
          padding: 0.5rem !important;
      }
  </style>

  <script>
      function filterTable(type) {
          const rows = document.querySelectorAll('.setting-row');
          rows.forEach(row => {
              if (type === 'all') {
                  row.classList.remove('hidden');
              } else {
                  if (row.dataset.type === type) {
                      row.classList.remove('hidden');
                  } else {
                      row.classList.add('hidden');
                  }
              }
          });
      }

      function filterCategory(category) {
          const rows = document.querySelectorAll('.setting-row');
          rows.forEach(row => {
              if (category === 'metatags') {
                  // Show all metatag categories
                  if (row.dataset.category.includes('metatags')) {
                      row.classList.remove('hidden');
                  } else {
                      row.classList.add('hidden');
                  }
              } else {
                  if (row.dataset.category === category) {
                      row.classList.remove('hidden');
                  } else {
                      row.classList.add('hidden');
                  }
              }
          });
      }
  </script>
{% endblock extra_head %}
